trigger:
  branches:
    include: [main]

pool:
  vmImage: ubuntu-latest

variables:
  # ----- Conexión de servicio a Azure (ARM) -----
  azureRM: "Conexion con Portal Azure - OLoor"

  # ----- Recursos Azure -----
  rg: "DHS"
  location: "eastus"
  acrName: "fp2pcontainer" # nombre del recurso ACR (sin .azurecr.io)
  imageRepo: "fastapi-excel" # repositorio dentro del ACR

  # ----- Rutas build -----
  dockerfilePath: "$(Build.SourcesDirectory)/Dockerfile"
  buildContext: "$(Build.SourcesDirectory)"

  # ----- App Service (Linux, contenedores) -----
  appServiceName: "fp2p-python"

  # ----- Container Apps (opcional) -----
  caEnv: "env-fastapi"
  caApp: "fastapi-excel-aca"

  # ----- App specifics -----
  containerPort: "8500"
  healthPath: "/health"

  # ----- Tags de imagen -----
  imageTagBuild: "$(Build.BuildId)" # siempre se construye
  imageTagDeploy: "latest" # el deploy usará ESTE tag

  # ----- Destino -----
  DEPLOY_TARGET: "appservice" # appservice | containerapps

  # ----- Fallback ACR Admin (true/false) -----
  useAcrAdminFallback: "true"

stages:
  # ================= BUILD en ACR (ACR Tasks) =================
  - stage: BuildPush
    displayName: Build in ACR (az acr build)
    jobs:
      - job: ACRBuild
        displayName: Build image inside ACR
        steps:
          - task: AzureCLI@2
            name: AcrBuild
            displayName: "ACR Task build (tags: BuildId y latest)"
            inputs:
              azureSubscription: "$(azureRM)"
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                set -euo pipefail
                echo "==> az account show (debug)"
                az account show -o table || true

                LOGIN_SERVER=$(az acr show -n "$(acrName)" --query loginServer -o tsv)
                echo "ACR loginServer: $LOGIN_SERVER"

                echo "==> Construyendo en ACR: $(imageRepo):$(imageTagBuild) y :latest"
                az acr build \
                  --registry "$(acrName)" \
                  --image "$(imageRepo):$(imageTagBuild)" \
                  --image "$(imageRepo):latest" \
                  --file "$(dockerfilePath)" \
                  "$(buildContext)"

                echo "##vso[task.setvariable variable=LOGIN_SERVER;isOutput=true]$LOGIN_SERVER"

  # ======================== DEPLOY =========================
  - stage: Deploy
    displayName: Deploy to Azure (App Service or Container Apps)
    dependsOn: BuildPush
    jobs:
      # -------- App Service for Containers --------
      - job: DeployAppService
        displayName: Deploy to App Service
        condition: eq(variables['DEPLOY_TARGET'], 'appservice')
        steps:
          # ---------- Preflight ACR ----------
          - task: AzureCLI@2
            displayName: "Preflight ACR (RBAC, networking, tag, reglas)"
            inputs:
              azureSubscription: "$(azureRM)"
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                set -euo pipefail
                ACR="$(acrName)"
                APP="$(appServiceName)"
                RG="$(rg)"
                REPO="$(imageRepo)"
                TAG="$(imageTagDeploy)"

                echo "==> Login server y estado general"
                LOGIN_SERVER=$(az acr show -n "$ACR" --query loginServer -o tsv)
                echo "LOGIN_SERVER=$LOGIN_SERVER"
                az acr show -n "$ACR" -o table

                echo "==> Verificando que el tag '$TAG' exista en $REPO"
                if ! az acr repository show-tags -n "$ACR" --repository "$REPO" -o tsv | grep -qx "$TAG"; then
                  echo "❌ El tag '$TAG' no existe en $REPO"; exit 1
                fi

                echo "==> Modo de asignación de roles"
                MODE=$(az acr show -n "$ACR" --query roleAssignmentMode -o tsv || echo "")
                echo "roleAssignmentMode=$MODE"
                [ "$MODE" = "rbac" ] || az acr update -n "$ACR" --role-assignment-mode rbac

                echo "==> Red del ACR (public network enabled) y firewall"
                az acr update -n "$ACR" --public-network-enabled true >/dev/null || true
                DEFAULT_ACTION=$(az acr show -n "$ACR" --query networkRuleSet.defaultAction -o tsv || echo "")
                echo "ACR firewall defaultAction=$DEFAULT_ACTION"
                if [ "$DEFAULT_ACTION" = "Deny" ]; then
                  echo "ACR en Deny: añadiendo outbound IPs del Web App a reglas..."
                  IPS=$(az webapp show -g "$RG" -n "$APP" --query outboundIpAddresses -o tsv | tr ',' ' ')
                  POSS=$(az webapp show -g "$RG" -n "$APP" --query possibleOutboundIpAddresses -o tsv | tr ',' ' ')
                  for ip in $IPS $POSS; do
                    echo " - Permit $ip/32"
                    az acr network-rule add -n "$ACR" --ip-address ${ip}/32 >/dev/null || true
                  done
                fi

                echo "==> Reglas actuales del ACR (resumen)"
                az acr show -n "$ACR" --query "networkRuleSet" -o json

                echo "==> Últimos tags del repo (muestra 10)"
                az acr repository show-tags -n "$ACR" --repository "$REPO" --top 10 --orderby time_desc -o table

          # ---------- Deploy con Managed Identity ----------
          - task: AzureCLI@2
            displayName: "Deploy: Managed Identity (AcrPull) + DOCKER|"
            inputs:
              azureSubscription: "$(azureRM)"
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                set -eux
                RG="$(rg)"; APP="$(appServiceName)"; ACR="$(acrName)"
                LOGIN_SERVER=$(az acr show -n "$ACR" --query loginServer -o tsv)
                FULL_IMAGE="${LOGIN_SERVER}/$(imageRepo):$(imageTagDeploy)"

                echo "==> Activar MI del Web App y asignar AcrPull"
                az webapp identity assign -g "$RG" -n "$APP" || true
                APP_MI=$(az webapp identity show -g "$RG" -n "$APP" --query principalId -o tsv)
                ACR_ID=$(az acr show -n "$ACR" --query id -o tsv)
                az role assignment create --assignee "$APP_MI" --role AcrPull --scope "$ACR_ID" || true
                echo "Roles del MI:"
                az role assignment list --assignee "$APP_MI" --scope "$ACR_ID" --query "[].roleDefinitionName" -o tsv || true

                echo "==> Forzar linuxFxVersion a DOCKER|..."
                az webapp config set -g "$RG" -n "$APP" \
                  --linux-fx-version "DOCKER|$FULL_IMAGE"

                echo "==> Container config (registry URL)"
                az webapp config container set \
                  -g "$RG" -n "$APP" \
                  --docker-custom-image-name "$FULL_IMAGE" \
                  --docker-registry-server-url "https://${LOGIN_SERVER}"

                echo "==> App settings (WEBSITES_PORT=$(containerPort))"
                az webapp config appsettings set \
                  -g "$RG" -n "$APP" \
                  --settings WEBSITES_PORT="$(containerPort)"

                echo "==> Usar Managed Identity para pulls"
                az resource update \
                  -g "$RG" \
                  -n "$APP/config/web" \
                  --resource-type "Microsoft.Web/sites/config" \
                  --set properties.acrUseManagedIdentityCreds=true

                echo "==> Restart Web App"
                az webapp restart -g "$RG" -n "$APP"

          # ---------- Fallback con Admin User (si está activado) ----------
          - task: AzureCLI@2
            displayName: "Fallback: ACR Admin user (desactiva MI para pulls) + DOCKER|"
            condition: eq(variables['useAcrAdminFallback'], 'true')
            inputs:
              azureSubscription: "$(azureRM)"
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                set -eux
                RG="$(rg)"; APP="$(appServiceName)"; ACR="$(acrName)"
                LOGIN_SERVER=$(az acr show -n "$ACR" --query loginServer -o tsv)
                FULL_IMAGE="${LOGIN_SERVER}/$(imageRepo):$(imageTagDeploy)"

                echo "==> Desactivar MI para pulls (clave para evitar sidecar de MI)"
                az resource update \
                  -g "$RG" \
                  -n "$APP/config/web" \
                  --resource-type "Microsoft.Web/sites/config" \
                  --set properties.acrUseManagedIdentityCreds=false

                echo "==> Habilitar Admin User del ACR y obtener credenciales"
                az acr update -n "$ACR" --admin-enabled true
                USER=$(az acr credential show -n "$ACR" --query username -o tsv)
                PASS=$(az acr credential show -n "$ACR" --query "passwords[0].value" -o tsv)

                echo "==> Forzar linuxFxVersion a DOCKER|..."
                az webapp config set -g "$RG" -n "$APP" \
                  --linux-fx-version "DOCKER|$FULL_IMAGE"

                echo "==> Configurar container con user/clave"
                az webapp config container set \
                  -g "$RG" -n "$APP" \
                  --docker-custom-image-name "$FULL_IMAGE" \
                  --docker-registry-server-url "https://${LOGIN_SERVER}" \
                  --docker-registry-server-user "$USER" \
                  --docker-registry-server-password "$PASS"

                echo "==> Restart Web App"
                az webapp restart -g "$RG" -n "$APP"

          # ---------- Diagnósticos post-deploy ----------
          - task: AzureCLI@2
            displayName: "Diagnóstico post-deploy (fxVersion, MI, container, ACR rules, IPs)"
            inputs:
              azureSubscription: "$(azureRM)"
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                set -eux
                RG="$(rg)"; APP="$(appServiceName)"; ACR="$(acrName)"; REPO="$(imageRepo)"

                echo "linuxFxVersion:"
                az webapp show -g "$RG" -n "$APP" --query "siteConfig.linuxFxVersion"

                echo "acrUseManagedIdentityCreds:"
                az resource show \
                  -g "$RG" \
                  -n "$APP/config/web" \
                  --resource-type "Microsoft.Web/sites/config" \
                  --query "properties.acrUseManagedIdentityCreds"

                echo "Container config:"
                az webapp config container show -g "$RG" -n "$APP"

                echo "WEBSITES_PORT:"
                az webapp config appsettings list -g "$RG" -n "$APP" --query "[?name=='WEBSITES_PORT']"

                echo "Outbound IPs:"
                az webapp show -g "$RG" -n "$APP" --query outboundIpAddresses -o tsv

                echo "ACR network defaultAction & ipRules (resumen):"
                az acr show -n "$ACR" --query "networkRuleSet" -o json

                echo "Últimos 5 tags del repo:"
                az acr repository show-tags -n "$ACR" --repository "$REPO" --top 5 --orderby time_desc -o table

          # ---------- Health checks ----------
          - task: AzureCLI@2
            displayName: "Health checks (/, /health) con reintentos"
            inputs:
              azureSubscription: "$(azureRM)"
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                set -euo pipefail
                RG="$(rg)"; APP="$(appServiceName)"
                HOST=$(az webapp show -g "$RG" -n "$APP" --query defaultHostName -o tsv)
                echo "HOST=$HOST"
                BASE="https://${HOST}"

                echo "==> Esperando 60s antes de health checks..."
                sleep 60

                try_curl() { url="$1"; name="$2"; tries=10; delay=6;
                  for i in $(seq 1 $tries); do
                    echo "[$i/$tries] GET $url"
                    code=$(curl -k -sS -o /dev/null -w "%{http_code}" --max-time 10 "$url" || echo "000")
                    echo "HTTP $code"
                    if [ "$code" -ge 200 ] && [ "$code" -lt 500 ]; then
                      echo "✅ $name OK"; return 0; fi
                    sleep $delay
                  done
                  echo "❌ $name FAILED"; return 1
                }

                set +e
                RC=0
                try_curl "${BASE}/" "root" || RC=1
                try_curl "${BASE}$(healthPath)" "health" || RC=1
                set -e
                exit $RC

          # ---------- Quick log tail (15s) ----------
          - task: AzureCLI@2
            displayName: "Quick log tail (15s)"
            inputs:
              azureSubscription: "$(azureRM)"
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                set -eux
                timeout 15s az webapp log tail -g "$(rg)" -n "$(appServiceName)" || true

      # -------- Azure Container Apps (opcional) --------
      - job: DeployContainerApps
        displayName: Deploy to Container Apps
        condition: eq(variables['DEPLOY_TARGET'], 'containerapps')
        steps:
          - task: AzureCLI@2
            displayName: "Preflight ACR (tag, RBAC, red)"
            inputs:
              azureSubscription: "$(azureRM)"
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                set -euo pipefail
                ACR="$(acrName)"; REPO="$(imageRepo)"; TAG="$(imageTagDeploy)"
                if ! az acr repository show-tags -n "$ACR" --repository "$REPO" -o tsv | grep -qx "$TAG"; then
                  echo "❌ El tag '$TAG' no existe en $REPO"; exit 1
                fi
                MODE=$(az acr show -n "$ACR" --query roleAssignmentMode -o tsv || echo "")
                [ "$MODE" = "rbac" ] || az acr update -n "$ACR" --role-assignment-mode rbac
                az acr update -n "$ACR" --public-network-enabled true >/dev/null || true

          - task: AzureCLI@2
            displayName: "Create/Update Container App (MI + ACR)"
            inputs:
              azureSubscription: "$(azureRM)"
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                set -eux
                az extension add -n containerapp -y || az extension update -n containerapp

                LOGIN_SERVER=$(az acr show -n "$(acrName)" --query loginServer -o tsv)
                FULL_IMAGE="${LOGIN_SERVER}/$(imageRepo):$(imageTagDeploy)"

                az containerapp env show -g "$(rg)" -n "$(caEnv)" >/dev/null 2>&1 || \
                  az containerapp env create -g "$(rg)" -n "$(caEnv)" -l "$(location)"

                if ! az containerapp show -g "$(rg)" -n "$(caApp)" >/dev/null 2>&1; then
                  az containerapp create \
                    -g "$(rg)" -n "$(caApp)" \
                    --environment "$(caEnv)" \
                    --image "$FULL_IMAGE" \
                    --ingress external --target-port "$(containerPort)" \
                    --registry-server "$LOGIN_SERVER" \
                    --registry-identity system \
                    --min-replicas 1
                else
                  az containerapp update \
                    -g "$(rg)" -n "$(caApp)" \
                    --image "$FULL_IMAGE"
                fi

                APP_MI=$(az containerapp show -g "$(rg)" -n "$(caApp)" --query identity.principalId -o tsv)
                ACR_ID=$(az acr show -n "$(acrName)" --query id -o tsv)
                az role assignment create --assignee "$APP_MI" --role AcrPull --scope "$ACR_ID" || true

                FQDN=$(az containerapp show -g "$(rg)" -n "$(caApp)" --query properties.configuration.ingress.fqdn -o tsv)
                echo "Container App URL: https://${FQDN}"
